<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Projection</title>
  <meta charset="UTF-8" />
  <meta name="theme-color" content="#354F52">
  <script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/latest/ui-shell.min.js"></script>
  <script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/latest/button.min.js"></script>
  <script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/latest/tag.min.js"></script>
  <script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/latest/notification.min.js"></script>
  

  <link rel="icon" href="https://blog.cloudant.com/favicon.png">

  

<link rel="stylesheet"
href="https://1.www.s81c.com/common/carbon-for-ibm-dotcom/tag/v1/canary/plex.css"/>
<link rel="stylesheet"
href="https://1.www.s81c.com/common/carbon-for-ibm-dotcom/tag/v1/canary/grid.css"/>

<style>
       
bx-header~bx-side-nav{margin-top:3rem;height:calc(100% - 3rem)}
.bx-hugo-carbon--ui-shell-content{
  will-change:margin-left;transition:margin-left .11s cubic-bezier(0.2, 0, 1, 0.9);
}
#main-content {margin-top: 3rem;}

@media(min-width: 66rem){

  #main-content{margin-left:16rem}

}
html {margin:0; font-family: "IBM Plex Sans", "Helvetica Neue", Arial, sans-serif;}
bx-side-nav {top:3rem; display: block; overflow: scroll;}
bx-header {display:flex; background: #000;color:#fff;height: 3rem;width:100%}
</style>


<link rel="stylesheet" type="text/css" href="https://blog.cloudant.com/css/main.css?i=000" media="all">



 




 <meta name="generator" content="Hugo 0.115.0">

  
    
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Projection">
    <meta property="og:url" content="https://blog.cloudant.com/2021/11/12/Projection.html" />
    <meta property="og:description" content="Storing data in an index for faster retrieval." />
    <meta property="article:published_time" content="2021-11-12 00:00:00 &#43;0000 UTC" />
    <meta property="og:site_name" content="Cloudant blog" />
    <meta property="og:image" content="/img/jeremy-yap-J39X2xX_8CQ-unsplash.jpg" />

    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="Cloudant blog" />
    <meta name="twitter:title" content="Projection" />
    <meta name="twitter:description" content="Storing data in an index for faster retrieval." />
    <meta name="twitter:creator" content="Cloudant blog" />

    
    <meta itemprop="name" content="Projection">
    <meta itemprop="description" content="Storing data in an index for faster retrieval.">
    <meta itemprop="image" content="/img/jeremy-yap-J39X2xX_8CQ-unsplash.jpg">
  




  
  <style>
@media (min-width: 66rem) {
.container .bx--grid {
  padding-left: calc(25% + 1.5rem);
  padding-right: 2rem;
}
}
    h3 {
      margin-bottom: 1rem;
    }
  </style>
  </head>
<body class="">
     
<bx-skip-to-content href="#main-content" role="navigation" aria-label="Skip to main content"></bx-skip-to-content>
<bx-header aria-label=" Cloudant blog" role="banner">
  <bx-header-name href="https://blog.cloudant.com/" prefix=""> Cloudant blog</bx-header-name>
  <bx-header-nav menu-bar-label=" Cloudant blog" role="navigation">
    
        
          
            <bx-header-nav-item active="" href="https://blog.cloudant.com/">Home</bx-header-nav-item>
          
        
          
            <bx-header-nav-item active="" href="https://blog.cloudant.com/search.html">Search</bx-header-nav-item>
          
        
    
  </bx-header-nav>
</bx-header>
<div style="height:50px"></div>
<main class="bx--content bx-hugo-carbon--ui-shell-content">
  <div class="bx--grid">
    <div class="bx--row">


<div class="bx--col-sm-12 bx--col-md-12 bx--col-lg-12  bx--col-xlg-12 bx--col-max-12">
  <h1 class="p-name">Projection</h1>
  
  <div class="postmeta">Nov 12, 2021 | Glynn Bird | 

  
  <bx-tag>Views</bx-tag>
  
  <bx-tag>Performance</bx-tag>
  


  </div>
  
  <p>Cloudant&rsquo;s MapReduce indexes give you complete control over what data from your primary JSON objects are stored in your secondary indexes. JavaScript functions are used to programmatically decide which document attributes are selected for inclusion as either the <em>key</em> or the <em>value</em> of the views - the JavaScript functions can even be used to process the data before it&rsquo;s saved in the index.</p>
<p><img src="https://blog.cloudant.com/img/jeremy-yap-J39X2xX_8CQ-unsplash.jpg" alt="projection"></p>
<blockquote>
<p>Photo by <a href="https://unsplash.com/photos/J39X2xX_8CQ">Jeremy Yap on Unsplash</a></p>
</blockquote>
<p>In this blog post we&rsquo;ll look at a technique called <em>projection</em> which produces the fastest, most efficient data selection indexes.</p>
<h2 id="mapreduce-basics"style="display:inline">MapReduce basics</h2><a class="stealth" href="#mapreduce-basics">ðŸ”—</a><br>
<p>A <a href="https://cloud.ibm.com/docs/Cloudant?topic=Cloudant-creating-views-mapreduce">MapReduce</a> index is defined in two parts</p>
<ol>
<li>The Map function - a JavaScript function which is called for each document in the database and chooses what is stored in the index.</li>
<li>The Reducer - in this blog post we&rsquo;re not concerned with aggregation of data, so we&rsquo;ll leave the reduce component undefined.</li>
</ol>
<p>The Map &amp; Reduce definitions are stored in <a href="https://cloud.ibm.com/docs/Cloudant?topic=Cloudant-design-documents">design documents</a> which define the specifcation of one or more secondary indexes. Here&rsquo;s an example map function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">doc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;complete&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">timestamp</span>, <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Note that:</p>
<ul>
<li>The function is called with a single parameter &lsquo;doc&rsquo; which contains the document being indexed.</li>
<li>The function uses an <code>if</code> statement to decided whether to index something or nothing. This is called a <em>partial</em> or <em>sparse</em> index as it only contains data for some of the documents. This keeps the index as compact and performant as possible.</li>
<li>The data emitted has two parts: the <code>key</code> and the <code>value</code> forming the first and second parameters to the <code>emit</code> function. The <code>key</code> determines the order of the index and consequently marries with the <em>access pattern</em> your index is serving i.e. by emitting a key of <code>doc.timestamp</code> we are creating a secondary index in date/time order allowing us to query data by a single timestamp or a range of time values. The <code>value</code> is null - the value is usually used to store data which is aggregated by the <em>reducer</em>, but for the moment we can elect to store nothing here.</li>
</ul>
<h2 id="using-the-view"style="display:inline">Using the view</h2><a class="stealth" href="#using-the-view">ðŸ”—</a><br>
<p>Once the above view has built, we can invoke the API endpoint associated with our view suppling parameters to define the slice of data we need:</p>
<ul>
<li><code>?key=&quot;2021-04-01T10:44:00.000Z&quot;</code> - find documents matching a single timestamp.</li>
<li><code>?startkey=&quot;2021-04-01&quot;&amp;endkey=&quot;2021-05-01&quot;</code> - find documents from April 20201.</li>
</ul>
<blockquote>
<p>Note: because of the <code>if</code> statement in the map function, we will only see documents where the <code>status</code> attribute is <code>completed</code>. We have baked only that subset of the documents into the secondary index.</p>
</blockquote>
<p>The data returned from these API calls will include:</p>
<ul>
<li>the &ldquo;key&rdquo; from the index</li>
<li>the matching document id</li>
<li>the &ldquo;value&rdquo; from the index - in this case <code>null</code></li>
</ul>
<p>Here is a sample response:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;total_rows&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">21953</span>,<span style="color:#e6db74">&#34;offset&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;rows&#34;</span><span style="color:#f92672">:</span>[
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;K7N2T4IR5JMJGJ8F&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:12:37.887Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ZYAMEN3Y56M6PLGG&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:25:45.818Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TUVG1CHYQ5EF5T6D&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:56:50.297Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;GFY67VNMC0J8AQBX&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:32:31.487Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;S7VZS7A31GV1QS96&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:55:19.592Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>}
</span></span><span style="display:flex;"><span>]}
</span></span></code></pre></div><p>If we want to see the document body itself for each returned row, we can add <code>include_docs=true</code> to our query and the results will also include the full document.</p>
<p>Example response:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;total_rows&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">23169</span>,<span style="color:#e6db74">&#34;offset&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;rows&#34;</span><span style="color:#f92672">:</span>[
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;K7N2T4IR5JMJGJ8F&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:12:37.887Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>,<span style="color:#e6db74">&#34;doc&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;K7N2T4IR5JMJGJ8F&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-c2ea27ee82feb91ba80708c5e8f83d29&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:12:37.887Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">72.23</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Dorathy Xiong&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;dorathy.xiong51243@hotmail.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;4574 Aston Street , Glossop, Shropshire, PL7 6VI&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ZYAMEN3Y56M6PLGG&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:25:45.818Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>,<span style="color:#e6db74">&#34;doc&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ZYAMEN3Y56M6PLGG&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-b215e5e7335d7ad8cac4e33073598c02&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:25:45.818Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">75.3</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Yajaira Gary&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;yajaira_gary@yahoo.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2784 Meal Lane , New Alresford, Montgomeryshire, GL9 0DR&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TUVG1CHYQ5EF5T6D&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:56:50.297Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>,<span style="color:#e6db74">&#34;doc&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TUVG1CHYQ5EF5T6D&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-00f9d105a31b3c86657f797f9eeb5b1b&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:56:50.297Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">36.51</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Kandi Bolduc&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;kandi9@meetup.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;4712 Burstead Road , Knottingley, Durham, SO35 6MK&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;GFY67VNMC0J8AQBX&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:32:31.487Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>,<span style="color:#e6db74">&#34;doc&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;GFY67VNMC0J8AQBX&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-989788f7d9e2cb881c92c44cdc765eed&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:32:31.487Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">28.08</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Santina Leal&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;santina_leal3384@gmail.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;6443 Ashlands Street , Eccles, Essex, KY8 9JC&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;delivered&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;S7VZS7A31GV1QS96&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:55:19.592Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">null</span>,<span style="color:#e6db74">&#34;doc&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;S7VZS7A31GV1QS96&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-ea8cf28f1e5c9af038d4120753c513ee&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:55:19.592Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8.99</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Thomas Abreu&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;thomas.abreu@duo.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;3250 Turfland Road , Kidsgrove, Radnorshire, EC8 5MQ&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;delivered&#34;</span>}}
</span></span><span style="display:flex;"><span>]}
</span></span></code></pre></div><p>The trouble with <code>include_docs=true</code> is it adds extra complexity to the query: Cloudant has to first find the matching view rows from the secondary index and then in a second operation, fetch the matching document bodies. Extra complexity means extra database load and poorer performance.</p>
<p>How can we avoid doing <code>include_docs=true</code>? Using projection!</p>
<h2 id="projection"style="display:inline">Projection</h2><a class="stealth" href="#projection">ðŸ”—</a><br>
<p><em>Projection</em> is the process of storing data in the <em>value</em> portion of the MapReduce index so that it is retrieved at query-time <em>without</em> having to do <code>include_docs=true</code>.</p>
<p>An index with data projected into the index&rsquo;s value makes for a larger index but as the index&rsquo;s value is stored next to the index&rsquo;s keys, retrieval of the data is much faster than fetching the entire document bodies in a separate operation.</p>
<p>Projected indexes are the fastest way of retrieving selections of data from a Cloudant database and should be used by users who want the fastest performance and the lowest server load for operational queries.</p>
<h3 id="projecting-the-entire-document"style="display:inline">Projecting the entire document</h3><a class="stealth" href="#projecting-the-entire-document">ðŸ”—</a><br>
<p>In this example we&rsquo;re adding the entire document into the index:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">doc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;complete&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">timestamp</span>, <span style="color:#a6e22e">doc</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This technique is suitable for small documents (&lt; a few KB). To be more optimal, we needn&rsquo;t put the document <code>_id</code>/<code>_rev</code> pair into the index as they are already part of the response so this code is better:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">doc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;complete&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">_id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">timestamp</span>, <span style="color:#a6e22e">doc</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Example response:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;total_rows&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">23169</span>,<span style="color:#e6db74">&#34;offset&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;rows&#34;</span><span style="color:#f92672">:</span>[
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;K7N2T4IR5JMJGJ8F&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:12:37.887Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;K7N2T4IR5JMJGJ8F&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-c2ea27ee82feb91ba80708c5e8f83d29&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:12:37.887Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">72.23</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Dorathy Xiong&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;dorathy.xiong51243@hotmail.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;4574 Aston Street , Glossop, Shropshire, PL7 6VI&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ZYAMEN3Y56M6PLGG&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:25:45.818Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ZYAMEN3Y56M6PLGG&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-b215e5e7335d7ad8cac4e33073598c02&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:25:45.818Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">75.3</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Yajaira Gary&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;yajaira_gary@yahoo.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2784 Meal Lane , New Alresford, Montgomeryshire, GL9 0DR&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TUVG1CHYQ5EF5T6D&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:56:50.297Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TUVG1CHYQ5EF5T6D&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-00f9d105a31b3c86657f797f9eeb5b1b&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:56:50.297Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">36.51</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Kandi Bolduc&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;kandi9@meetup.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;4712 Burstead Road , Knottingley, Durham, SO35 6MK&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;GFY67VNMC0J8AQBX&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:32:31.487Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;GFY67VNMC0J8AQBX&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-989788f7d9e2cb881c92c44cdc765eed&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:32:31.487Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">28.08</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Santina Leal&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;santina_leal3384@gmail.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;6443 Ashlands Street , Eccles, Essex, KY8 9JC&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;delivered&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;S7VZS7A31GV1QS96&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:55:19.592Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;S7VZS7A31GV1QS96&#34;</span>,<span style="color:#e6db74">&#34;_rev&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1-ea8cf28f1e5c9af038d4120753c513ee&#34;</span>,<span style="color:#e6db74">&#34;status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;complete&#34;</span>,<span style="color:#e6db74">&#34;timestamp&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:55:19.592Z&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8.99</span>,<span style="color:#e6db74">&#34;buyer&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Thomas Abreu&#34;</span>,<span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;thomas.abreu@duo.com&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;3250 Turfland Road , Kidsgrove, Radnorshire, EC8 5MQ&#34;</span>,<span style="color:#e6db74">&#34;delivery&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;delivered&#34;</span>}}
</span></span><span style="display:flex;"><span>]}
</span></span></code></pre></div><h3 id="projecting-only-the-data-that-is-needed"style="display:inline">Projecting only the data that is needed</h3><a class="stealth" href="#projecting-only-the-data-that-is-needed">ðŸ”—</a><br>
<p>Even better than lazily emitting the entire document into the index&rsquo;s value is to only emit the key/value pairs that your application <em>needs</em>. e.g.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">doc</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;complete&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">p</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">price</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">buyer</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">e</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">email</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">d</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">delivery</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">timestamp</span>, <span style="color:#a6e22e">obj</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Note we create a new <code>obj</code> object which only contains the items we need for our use-case.</li>
<li>We don&rsquo;t need to emit <code>_id</code> as it is already stored in the index.</li>
<li>We don&rsquo;t need <code>doc.status</code> because the index will only contain documents with a <code>completed</code> status.</li>
<li>We don&rsquo;t need <code>doc.timestamp</code> because this is already stored in the index&rsquo;s key.</li>
<li>We use single character keys in the object to keep the size small.</li>
</ul>
<p>Example response:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;total_rows&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">23169</span>,<span style="color:#e6db74">&#34;offset&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;rows&#34;</span><span style="color:#f92672">:</span>[
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;K7N2T4IR5JMJGJ8F&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:12:37.887Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;p&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">72.23</span>,<span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Dorathy Xiong&#34;</span>,<span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;dorathy.xiong51243@hotmail.com&#34;</span>,<span style="color:#e6db74">&#34;d&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ZYAMEN3Y56M6PLGG&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:25:45.818Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;p&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">75.3</span>,<span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Yajaira Gary&#34;</span>,<span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;yajaira_gary@yahoo.com&#34;</span>,<span style="color:#e6db74">&#34;d&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TUVG1CHYQ5EF5T6D&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T00:56:50.297Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;p&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">36.51</span>,<span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Kandi Bolduc&#34;</span>,<span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;kandi9@meetup.com&#34;</span>,<span style="color:#e6db74">&#34;d&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;failed&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;GFY67VNMC0J8AQBX&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:32:31.487Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;p&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">28.08</span>,<span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Santina Leal&#34;</span>,<span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;santina_leal3384@gmail.com&#34;</span>,<span style="color:#e6db74">&#34;d&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;delivered&#34;</span>}},
</span></span><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;S7VZS7A31GV1QS96&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2020-04-01T01:55:19.592Z&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#34;p&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8.99</span>,<span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Thomas Abreu&#34;</span>,<span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;thomas.abreu@duo.com&#34;</span>,<span style="color:#e6db74">&#34;d&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;delivered&#34;</span>}}
</span></span><span style="display:flex;"><span>]}
</span></span></code></pre></div><hr>
<h2 id="conclusion"style="display:inline">Conclusion</h2><a class="stealth" href="#conclusion">ðŸ”—</a><br>
<p>Projection of small objects into a MapReduce index&rsquo;s value is the recipe for the fastest performance for boilerplate queries. It is faster and cheaper to execute than a view with <code>?include_docs=true</code> at the expense of a slightly larger index size.</p>

</div>
</div>
</div>
</main>



</body>
</html>

